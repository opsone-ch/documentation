---
# configuration
image: python:3-slim

# stages
stages:
  - deploy_test
  - deploy_prod

# hidden job template used on prod and stage
.build_sphinx: &build_sphinx
  # load SSH deploy key
  - apt-get update
  - 'which ssh-agent || apt-get -y install openssh-client'
  - eval $(ssh-agent -s)
  - ssh-add <(echo "$SSH_PRIVATE_KEY")
  - mkdir -p ~/.ssh
  - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
  # install dependencies
  - apt-get -y install rsync
  - pip install Sphinx==3.0.0b1
  - pip install sphinx_rtd_theme
  # build documentation
  - sphinx-build . ./_build/

deploy_prod:
  stage: deploy_prod
  environment: PROD
  only:
    - 5-0-stable@platform/docs
  script:
    - *build_sphinx
    - rsync -avz --delete ./_build/ ${PROD_USERNAME}@${PROD_SERVERNAME}:~/www/${CI_BUILD_REF_NAME}/

deploy_test:
  stage: deploy_test
  environment: test
  script:
    - *build_sphinx
    - rsync -avz --delete ./_build/ ${STAGE_USERNAME}@${STAGE_SERVERNAME}:~/www/${CI_BUILD_REF_NAME}/

